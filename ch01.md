# 1 前言

## 1.1 小型嵌入式系统中的多任务处理

### 1.1.1 关于FreeRTOS内核

FreeRTOS 是一个由 C 语言库组成的集合，包含一个实时内核和一组实现补充功能的模块化库。

Richard Barry 于 2003 年左右首次开发了 FreeRTOS。此后，Richard 的公司 Real-Time Engineers Ltd 与全球领先的芯片公司密切合作，继续推进 FreeRTOS 的开发，直到 2016 年亚马逊网络服务（Amazon Web Services，AWS）接手了 FreeRTOS 的管理工作。如今，Richard 在 AWS IoT 团队中担任高级首席工程师，继续他在 FreeRTOS 上的工作。FreeRTOS 是基于 MIT 许可的开源代码，可供任何用途使用。您无需成为 AWS 客户即可从 AWS 对 FreeRTOS 的管理中受益！

FreeRTOS 内核非常适合运行在微控制器或小型微处理器上的深度嵌入式实时应用程序。这类应用通常包含硬实时和软实时需求的混合。

软实时需求规定了一个时间期限——但即使超出期限也不会使系统失效。例如，响应按键的速度过慢可能会让系统显得反应迟钝，但实际上并不会导致其不可用。

硬实时需求同样规定了一个时间期限——但一旦超出期限将导致系统的绝对失效。例如，如果驾驶员的安全气囊对碰撞传感器输入的响应过慢，则可能弊大于利。

FreeRTOS 内核是一个实时内核（或实时调度器），它能够帮助基于 FreeRTOS 构建的应用程序满足其硬实时需求。它允许应用程序被组织为一系列独立的执行线程。例如，在只有一个核心的处理器上，任何时候只能有一个执行线程运行。内核通过检查每个线程被应用程序设计者分配的优先级来决定运行哪个线程。在最简单的情况下，应用程序设计者可以为实现硬实时需求的线程分配更高的优先级，而为实现软实时需求的线程分配较低的优先级。以这种方式分配优先级可以确保硬实时线程始终优先于软实时线程执行，但优先级分配决策并不总是如此简单。

如果您尚未完全理解前一段中的概念，请不必担心。后续章节将提供详细说明，并通过大量示例帮助您理解如何使用实时内核，尤其是 FreeRTOS。

### 1.1.2 价值主张

FreeRTOS 内核在全球范围内的空前成功源于其极具吸引力的价值主张：FreeRTOS 采用专业开发流程，严格的质量控制，具有稳健性、支持性，不存在任何知识产权归属的模糊性，并且在商业应用中真正免费使用，无需公开您的专有源代码。此外，AWS 的管理提供了全球影响力、专业的安全事件响应机制、庞大且多样化的开发团队、形式验证、渗透测试、内存安全证明以及长期支持等专业知识——同时始终保持 FreeRTOS 作为硬件、开发工具和云服务中立的开源项目。FreeRTOS 的开发过程透明且以社区驱动的方式在 GitHub 上进行，不需要任何特殊工具或开发实践。

您可以使用 FreeRTOS 将产品推向市场，甚至无需告知我们，更不用支付任何费用，成千上万的公司正是这样做的。如果您在任何时候希望获得额外的支持，或者您的法务团队需要额外的书面保证或赔偿，我们的战略合作伙伴也提供了简单且低成本的商业许可选项。您可以随时选择商业路线，这种安心感本身就是一种保障。


### 1.1.3 关于术语的说明

在 FreeRTOS 中，每个执行线程被称为“任务”。嵌入式社区中对于术语的使用没有统一的标准，但我更倾向于使用“任务”而非“线程”，因为在某些应用领域中，“线程”可能具有更具体的含义。


### 1.1.4 为什么要使用实时操作系统（RTOS）？

有许多成熟的技术可以在不使用多线程内核的情况下编写良好的嵌入式软件。如果正在开发的系统较为简单，那么这些技术可能会提供最合适的解决方案。在更复杂的情况下，使用内核可能是更好的选择，但切换点的位置始终是主观的。

正如前面所描述的，任务优先级的设置可以帮助确保应用程序满足其处理期限，但内核还可以带来其他不太明显的好处。以下简要列出了一些优势：

- **抽象时间信息**

  实时操作系统负责执行时间管理，并向应用程序提供与时间相关的 API。这使得应用程序代码的结构更加简洁，整体代码规模更小。

- **可维护性/可扩展性**

  抽象时间细节可以减少模块之间的相互依赖性，并允许软件以可控且可预测的方式演进。此外，由于内核负责时间管理，因此应用程序性能对底层硬件变化的敏感性较低。

- **模块化**

  任务是独立的模块，每个模块都应有明确的目的。

- **团队开发**

  任务还应具备明确定义的接口，从而更容易实现团队协作开发。

- **更易于测试**

  具有清晰接口的、定义明确的独立任务模块更容易单独进行测试。

- **代码复用**

  设计为更高模块化和更少依赖性的代码更容易被复用。

- **提升效率**

  使用实时操作系统的应用程序可以完全基于事件驱动运行。无需通过轮询未发生的事件来浪费处理时间。

  尽管事件驱动带来了效率提升，但需要处理实时操作系统的滴答中断并从一个任务切换到另一个任务。然而，即使不使用实时操作系统的应用程序通常也会包含某种形式的滴答中断。

- **空闲时间**

  当没有需要处理的应用程序任务时，自动创建的空闲任务（Idle task）会执行。空闲任务可用于测量剩余的处理能力、执行后台检查或将处理器置于低功耗模式。

- **电源管理**

  使用实时操作系统所带来的效率提升让处理器能够在低功耗模式下停留更长时间。

  每次空闲任务运行时，将处理器置于低功耗状态可以显著降低功耗。FreeRTOS 还具有一种特殊的无滴答模式（tick-less mode）。使用无滴答模式可以让处理器进入比平常更低的功耗模式，并在低功耗模式下保持更长时间。

- **灵活的中断处理**

  中断处理程序可以通过将处理推迟到由应用程序开发者创建的任务或自动创建的实时操作系统守护任务（也称为定时器任务，RTOS daemon task）来保持非常短的处理时间。

- **混合处理需求**

  简单的设计模式可以在应用程序中实现周期性、连续性和事件驱动处理的混合。此外，通过选择适当的任务和中断优先级，可以满足硬实时和软实时的需求。


### 1.1.5 FreeRTOS内核功能

FreeRTOS内核具有以下标准功能：

- 抢占式或协作式操作
- 可选的时间片轮转
- 非常灵活的任务优先级分配
- 灵活、快速且轻量的任务通知机制
- 队列
- 二进制信号量
- 计数信号量
- 互斥锁
- 递归互斥锁
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- 滴答钩子函数
- 空闲钩子函数
- 堆栈溢出检查
- 跟踪宏
- 任务运行时统计信息收集
- 可选的商业许可和支持
- 完整的中断嵌套模型（适用于某些架构）
- 极低功耗应用的无滴答能力（适用于某些架构）
- 内存保护单元支持，用于隔离任务并提高应用程序的安全性（适用于某些架构）
- 在适当情况下使用软件管理的中断堆栈（这有助于节省RAM）
- 使用静态或动态分配的内存创建RTOS对象的能力


### 1.1.6 许可证以及FreeRTOS、OpenRTOS和SafeRTOS系列

**FreeRTOS** 的 MIT 开源许可证旨在确保以下几点：

- FreeRTOS 可以在商业应用中使用。

- FreeRTOS 本身对所有人仍然免费开放。

- FreeRTOS 用户保留其知识产权的所有权。

有关最新的开源许可证信息，请参见 <https://www.FreeRTOS.org/license>。

**OpenRTOS** 是由第三方根据亚马逊网络服务（Amazon Web Services）提供的商业许可版本的 FreeRTOS。

**SafeRTOS** 与 FreeRTOS 具有相同的使用模型，但其开发遵循了符合各种国际认可的安全相关标准所需的实践、程序和流程。


## 1.2 包含的源文件和项目

### 1.2.1 获取本书附带的示例

可从 <https://www.FreeRTOS.org/Documentation/code> 下载的 zip 文件包含了构建和运行本书中展示的示例所需的所有源代码、预配置的项目文件和说明。请注意，zip 文件不一定包含最新版本的 FreeRTOS。

本书中包含的屏幕截图显示了这些示例在 Microsoft Windows 环境中使用 FreeRTOS Windows 移植版运行的情况。使用 FreeRTOS Windows 移植版的项目已预先配置为使用免费的 Visual Studio 社区版进行构建，该版本可从 <https://www.visualstudio.com/> 获取。需要注意的是，虽然 FreeRTOS Windows 移植版提供了一个方便的评估、测试和开发平台，但它*并不*提供真正的实时行为。


