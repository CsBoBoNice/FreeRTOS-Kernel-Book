# 1 前言

## 1.1 小型嵌入式系统中的多任务处理

### 1.1.1 关于 FreeRTOS 内核

FreeRTOS 是一组 C 库的集合，包括一个实时内核和一组实现互补
功能的模块化库。

Richard Barry 最初于 2003 年左右开发了 FreeRTOS。Richard 公司的 Real-Time
Engineers Ltd 在与全球领先的芯片公司密切合作的情况下继续 FreeRTOS 的开发，直到 Amazon
Web Services (AWS) 于 2016 年接管 FreeRTOS。Richard 现在继续作为 AWS IoT 团队的高级首席工程师在 FreeRTOS 上工作。FreeRTOS 采用 MIT 许可的开源代码，可用于任何目的。您无需成为 AWS 客户即可受益于 AWS 的支持！

FreeRTOS 内核非常适合于在微控制器或小型微处理器上运行的深度嵌入式实时应用程序。这类应用程序通常包含硬实时和软实时要求的混合。

软实时要求声明了一个时间截止日期——但超出截止日期不会使系统失效。例如，对按键响应过慢可能会使系统看起来令人恼火，而不会使其无法使用。

硬实时要求声明了一个时间截止日期——并且超出截止日期将导致系统绝对失效。例如，驾驶员的安全气囊如果对碰撞传感器输入响应过慢，可能会造成更大的危害。

FreeRTOS 内核是一个实时内核（或实时调度器），它使基于 FreeRTOS 构建的应用程序能够满足其硬实时要求。它使应用程序能够组织为一组独立的执行线程。例如，在只有一个核心的处理器上，一次只能执行一个执行线程。内核通过检查应用程序设计器分配给每个线程的优先级来决定要执行哪个线程。在最简单的情况下，应用程序设计器可以将更高的优先级分配给实现硬实时要求的线程，并将更低的优先级分配给实现软实时要求的线程。以这种方式分配优先级将确保硬实时线程始终在软实时线程之前执行，但优先级分配决策并不总是如此简单。

如果您现在还没有完全理解上一段中的概念，请不要担心。以下章节将提供详细的解释，并提供许多示例，以帮助您理解如何使用实时内核，特别是 FreeRTOS。


### 1.1.2 价值主张

FreeRTOS 内核前所未有的全球成功源于其引人注目的价值主张：FreeRTOS 是专业开发的，严格质量控制的，健壮的，有支持的，不包含任何知识产权所有权歧义，并且真正可以在商业应用中免费使用，而无需暴露您的专有源代码。此外，AWS 的支持提供了全球影响力，专业的安全事件响应程序，一个庞大而多元化的开发团队，正式验证方面的专业知识，渗透测试，内存安全证明，以及长期支持——所有这些都同时保持 FreeRTOS 作为硬件、开发工具和云服务中立的开源项目。FreeRTOS 的开发在 GitHub 上透明且由社区驱动，并且不需要任何特殊的工具或开发实践。

您可以使用 FreeRTOS 将产品推向市场，甚至无需告诉我们，更不用说支付任何费用了，成千上万的公司就是这么做的。如果您在任何时候需要额外的备份，或者您的法律团队需要额外的书面保证或赔偿，那么我们的战略合作伙伴提供简单的低成本商业许可选项。内心的平静来自于知道您可以随时选择走商业路线。


### 1.1.3 关于术语的说明

在 FreeRTOS 中，每个执行线程被称为“任务”。嵌入式社区中对于术语并没有达成共识，但我更喜欢“任务”而不是“线程”，因为“线程”在某些应用领域可能具有更具体的含义。

### 1.1.4 为什么使用RTOS？

有很多成熟的技术可以在不使用多线程内核的情况下编写出色的嵌入式软件。如果正在开发的系统很简单，那么这些技术可能提供最合适的解决方案。在更复杂的情况下，使用内核可能更可取，但交叉点何时出现将始终是主观的。

正如前面所述，任务优先级可以帮助确保应用程序满足其处理截止日期，但内核可以带来其他不太明显的优势。其中一些优势简要列出如下。

- 抽象掉定时信息

  RTOS 负责执行定时，并为应用程序提供与时间相关的 API。这使得应用程序代码的结构更加简单，并且可以减小整体代码量。

- 可维护性/可扩展性

  抽象掉定时细节可以减少模块之间的相互依赖，并允许软件以可控和可预测的方式演进。此外，内核负责定时，因此应用程序性能不太容易受到底层硬件变化的影响。

- 模块化

  任务是独立的模块，每个模块都应该具有明确的目的。

- 团队开发

  任务也应该具有明确的接口，从而更容易进行团队开发。

- 更容易测试

  定义明确、独立的模块，并且具有清晰接口的任务，更容易单独进行测试。

- 代码重用

  设计具有更高模块化程度和更少相互依赖的代码更容易重用。

- 提高效率

  使用RTOS的应用程序代码可以完全基于事件驱动。无需浪费处理时间来轮询尚未发生的事件。

  抵消事件驱动带来的效率提升的是需要处理RTOS滴答中断并将执行从一个任务切换到另一个任务。但是，通常情况下，未使用RTOS的应用程序也会包含某种形式的滴答中断。

- 空闲时间

  自动创建的空闲任务在没有需要处理的应用程序任务时执行。空闲任务可以测量剩余的处理能力，执行后台检查，或将处理器置于低功耗模式。

- 电源管理

  使用RTOS带来的效率提升使得处理器可以花更多的时间处于低功耗模式。

  每次空闲任务运行时，将处理器置于低功耗状态可以显著降低功耗。FreeRTOS还提供了一种特殊的无滴答模式。使用无滴答模式允许处理器进入比通常情况下更低的功耗模式，并在低功耗模式下保持更长时间。

- 灵活的中断处理

  通过将处理延迟到应用程序编写器创建的任务或自动创建的RTOS守护任务（也称为定时器任务）中，可以将中断处理程序保持非常短。

- 混合处理需求

  简单的设计模式可以在应用程序中实现周期性、连续性和事件驱动处理的混合。此外，通过选择适当的任务和中断优先级，可以满足硬实时和软实时需求。

### 1.1.5 FreeRTOS 内核特性

FreeRTOS 内核具有以下标准特性：

- 抢占式或协同式操作
- 可选的时间分片
- 非常灵活的任务优先级分配
- 灵活、快速且轻量级任务通知机制
- 队列
- 二进制信号量
- 计数信号量
- 互斥锁
- 递归互斥锁
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- 滴答钩子函数
- 空闲钩子函数
- 堆栈溢出检查
- 跟踪宏
- 任务运行时统计信息收集
- 可选的商业许可和支持
- 全中断嵌套模型（对于某些架构）
- 用于极低功耗应用的无滴答功能（对于某些架构）
- 内存保护单元支持，用于隔离任务并提高应用程序安全性（对于某些架构）
- 在适当情况下使用软件管理的 中断堆栈（这有助于节省 RAM）
- 能够使用静态或动态分配的内存创建 RTOS 对象


### 1.1.6 许可，以及 FreeRTOS、OpenRTOS 和 SafeRTOS 系列

**FreeRTOS** MIT 开源许可证的设计旨在确保：

- FreeRTOS 可以在商业应用中使用。

- FreeRTOS 本身仍然免费提供给所有人。

- FreeRTOS 用户保留其知识产权的所有权。

请参阅 <https://www.FreeRTOS.org/license> 以获取最新的开源许可证信息。

**OpenRTOS** 是由第三方根据亚马逊网络服务许可提供的 FreeRTOS 的商业许可版本。

**SafeRTOS** 采用与 FreeRTOS 相同的用法模型，但已根据必要的实践、程序和流程进行开发，以声称符合各种国际公认的安全相关标准。

## 1.2 包含的源文件和项目

### 1.2.1 获取本书附带的示例

从 <https://www.FreeRTOS.org/Documentation/code> 下载的 zip 文件包含构建和执行本书中呈现的所有示例所需的全部源代码、预配置的项目文件和说明。请注意，zip 文件可能不包含 FreeRTOS 的最新版本。

本书中包含的屏幕截图显示了示例在 Microsoft Windows 环境中运行，并使用 FreeRTOS Windows 端口。使用 FreeRTOS Windows 端口的项目已预配置为使用 Visual Studio 免费 Community 版本构建，该版本可从 <https://www.visualstudio.com/> 获取。请注意，虽然 FreeRTOS Windows 端口提供了一个方便的评估、测试和开发平台，但它*不*提供真正的实时行为。


