# 1 前言

## 1.1 小型嵌入式系统中的多任务处理

### 1.1.1 关于FreeRTOS内核

FreeRTOS 是一组 C 语言库的集合，包含一个实时内核和一组实现辅助功能的模块化库。

FreeRTOS 最初由 Richard Barry 于 2003 年左右开发。Richard 的公司 Real-Time Engineers Ltd 与世界领先的芯片公司紧密合作，继续开发 FreeRTOS，直到 2016 年亚马逊网络服务（AWS）接管了 FreeRTOS。Richard 现在作为 AWS IoT 团队的高级首席工程师继续从事 FreeRTOS 的工作。FreeRTOS 是 MIT 许可证的开源代码，可用于任何目的。你不必成为 AWS 客户即可从 AWS 的托管中受益！

FreeRTOS 内核非常适合在微控制器或小型微处理器上运行的深度嵌入式实时应用程序。此类应用程序通常包括硬实时和软实时要求的混合。

软实时要求规定了时间期限，但违反期限不会使系统失效。例如，对按键响应过慢可能会使系统显得迟钝且令人恼火，但并不会使其无法使用。

硬实时要求规定了时间期限，违反期限将导致系统的绝对失败。例如，如果驾驶员的安全气囊对碰撞传感器输入的响应过慢，可能造成更多的伤害而非保护。

FreeRTOS 内核是一个实时内核（或实时调度程序），使基于 FreeRTOS 构建的应用程序能够满足其硬实时要求。它使应用程序能够组织为一系列独立的执行线程。例如，在只有一个核心的处理器上，任何时候只能执行一个执行线程。内核通过检查应用程序设计者为每个线程分配的优先级来决定执行哪个线程。在最简单的情况下，应用程序设计者可以为实现硬实时要求的线程分配更高的优先级，而为实现软实时要求的线程分配较低的优先级。以这种方式分配优先级将确保硬实时线程始终优先于软实时线程执行，但优先级分配决策并不总是那么简单。

如果你尚未完全理解上一段中的概念，请不要担心。接下来的章节将提供详细的解释，并通过大量示例帮助你理解如何使用实时内核，特别是 FreeRTOS。


### 1.1.2 价值主张

FreeRTOS内核在全球取得的空前成功源于其极具吸引力的价值主张：FreeRTOS经过专业开发、严格质量控制，具有强大的功能和完善的支持。它不包含任何知识产权归属的模糊性，并且真正免费用于商业应用，无需公开您的专有源代码。此外，AWS的托管为FreeRTOS提供了全球影响力、专业的安全事件响应流程、庞大且多样化的开发团队、形式验证的专业知识、渗透测试、内存安全证明以及长期支持——同时保持FreeRTOS作为硬件、开发工具和云服务中立的开源项目。FreeRTOS的开发在GitHub上是透明且由社区驱动的，不需要任何特殊工具或开发实践。

您可以使用FreeRTOS将产品推向市场，甚至无需告知我们，更不用说支付任何费用，成千上万的公司正是这样做的。如果您在任何时候希望获得额外的支持，或者您的法律团队需要额外的书面保证或赔偿，我们的战略合作伙伴提供简单且低成本的商业许可选项。让您安心的是，您可以选择随时采用商业化路线。


### 1.1.3 关于术语的说明

在FreeRTOS中，每个执行线程被称为“任务”（task）。在嵌入式社区中，术语的使用并没有达成共识，但我更倾向于使用“任务”而非“线程”，因为在某些应用领域中，“线程”可能具有更特定的含义。

### 1.1.4 为什么要使用RTOS？

有许多成熟的技术可以在不使用多线程内核的情况下编写出优秀的嵌入式软件。如果开发的系统较为简单，那么这些技术可能是最合适的解决方案。在更复杂的情况下，使用内核可能会更可取，但何时需要这种转变始终是主观的。

如前所述，任务优先级可以帮助确保应用程序满足其处理截止时间，但内核还能带来其他不那么明显的好处。以下简要列出其中一些：

- **抽象化定时信息**

  RTOS负责执行定时，并向应用程序提供与时间相关的API。这使得应用程序代码的结构更加简单明了，整体代码量也更小。

- **可维护性/可扩展性**

  抽象化定时细节减少了模块之间的相互依赖，使软件能够以可控和可预测的方式演进。此外，内核负责定时，因此应用程序性能对底层硬件变化的敏感性降低。

- **模块化**

  任务是独立的模块，每个模块都应具有明确定义的目的。

- **团队开发**

  任务还应具有明确定义的接口，便于团队开发。

- **更易于测试**

  作为具有清晰接口的明确定义的独立模块，任务更易于单独测试。

- **代码重用**

  设计更具模块化且相互依赖更少的代码更易于重用。

- **提高效率**

  使用RTOS的应用程序代码可以完全由事件驱动。无需浪费处理时间去轮询尚未发生的事件。

  抵消事件驱动带来的效率提升的是需要处理RTOS滴答中断并在任务之间切换执行。然而，不使用RTOS的应用程序通常也会包含某种形式的滴答中断。

- **空闲时间**

  自动创建的空闲任务在没有应用程序任务需要处理时执行。空闲任务可以测量剩余处理能力，执行后台检查，或将处理器置于低功耗模式。

- **电源管理**

  使用RTOS带来的效率提升使处理器能够更长时间处于低功耗模式。

  每次空闲任务运行时将处理器置于低功耗状态可以显著降低功耗。FreeRTOS还具有一种特殊的无滴答模式。使用无滴答模式可以使处理器进入比通常情况下更低的功耗模式，并保持在该模式更长时间。

- **灵活的中断处理**

  通过将处理推迟到应用程序编写者创建的任务或自动创建的RTOS守护任务（也称为定时器任务），可以保持中断处理程序非常简短。

- **混合处理需求**

  简单的设计模式可以在应用程序中实现周期性、连续性和事件驱动处理的混合。此外，通过选择适当的任务和中断优先级，可以满足硬实时和软实时需求。


### 1.1.5 FreeRTOS 内核特性

FreeRTOS 内核具有以下标准特性：

- 抢占式或协作式操作
- 可选的时间片调度
- 非常灵活的任务优先级分配
- 灵活、快速且轻量级的任务通知机制
- 队列
- 二值信号量
- 计数信号量
- 互斥锁
- 递归互斥锁
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- 滴答钩子函数
- 空闲钩子函数
- 栈溢出检查
- 跟踪宏
- 任务运行时统计信息收集
- 可选的商业许可和支持
- 完整的中断嵌套模型（适用于某些架构）
- 适用于极低功耗应用的滴答无感模式（适用于某些架构）
- 内存保护单元支持，用于隔离任务并提高应用安全性（适用于某些架构）
- 在适当情况下使用软件管理的中断栈（这有助于节省RAM）
- 使用静态或动态分配的内存创建RTOS对象的能力


### 1.1.6 许可协议，以及FreeRTOS、OpenRTOS和SafeRTOS家族

**FreeRTOS** 采用MIT开源许可证，旨在确保以下三点：

- FreeRTOS可用于商业应用程序。

- FreeRTOS本身对所有人保持免费可用。

- FreeRTOS用户保留其知识产权的所有权。

有关最新的开源许可证信息，请参见 <https://www.FreeRTOS.org/license>。

**OpenRTOS** 是FreeRTOS的商业许可版本，由第三方通过亚马逊网络服务（Amazon Web Services）授权提供。

**SafeRTOS** 与FreeRTOS具有相同的使用模式，但其开发过程遵循了必要的实践、程序和流程，以符合各种国际公认的安全相关标准的要求。

## 1.2 包含的源文件和项目

### 1.2.1 获取本书附带的示例

从 <https://www.FreeRTOS.org/Documentation/code> 下载的zip文件包含构建和执行本书中示例所需的所有源代码、预配置的项目文件和说明。请注意，该zip文件不一定包含最新版本的FreeRTOS。

本书中的截图显示了在Microsoft Windows环境中使用FreeRTOS Windows端口执行的示例。使用FreeRTOS Windows端口的项目已预配置为使用Visual Studio的免费社区版进行构建，可从 <https://www.visualstudio.com/> 获取。请注意，尽管FreeRTOS Windows端口提供了一个方便的评估、测试和开发平台，但它*不*提供真正的实时行为。


