# 1 前言

## 1.1 小型嵌入式系统中的多任务处理

### 1.1.1 关于FreeRTOS内核

FreeRTOS是一组C库的集合，包括一个实时内核和一组模块化库，这些库实现了补充功能。

理查德·巴里（Richard Barry）大约在2003年首次开发了FreeRTOS。理查德的公司Real-Time Engineers Ltd继续与全球领先的芯片公司密切合作开发FreeRTOS，直到2016年亚马逊网络服务（AWS）接管了FreeRTOS。理查德现在作为AWS IoT团队的高级首席工程师继续他的FreeRTOS工作。FreeRTOS是开源代码，采用MIT许可证，可用于任何目的。你不必是AWS客户就能从AWS的管理中受益！

FreeRTOS内核非常适合在微控制器或小型微处理器上运行的深度嵌入式实时应用程序。这种应用程序通常包括硬实时和软实时需求的混合。

软实时需求规定了时间截止日期，但超出截止日期不会使系统无用。例如，响应键盘输入过慢可能会使系统显得令人讨厌地无响应，但不会使其无法使用。

硬实时需求规定了时间截止日期，超出截止日期将导致系统绝对失败。例如，驾驶员的气囊如果对碰撞传感器输入响应过慢，可能会比不响应更危险。

FreeRTOS内核是一个实时内核（或实时调度程序），使基于FreeRTOS构建的应用程序能够满足其硬实时需求。它使应用程序能够组织为一组独立的执行线程。例如，在只有一个核心的处理器上，一次只能执行一个执行线程。内核通过检查应用程序设计师为每个线程分配的优先级来决定要执行哪个线程。在最简单的情况下，应用程序设计师可以为实现硬实时需求的线程分配较高的优先级，为实现软实时需求的线程分配较低的优先级。以这种方式分配优先级将确保硬实时线程总是优先于软实时线程执行，但优先级分配决策并不总是那么简单。

如果你还不完全理解前面段落中的概念，不要担心。接下来的章节将详细解释，并提供许多示例，帮助你理解如何使用实时内核，特别是FreeRTOS。


### 1.1.2 价值主张

FreeRTOS内核前所未有的全球成功源于其强大的价值主张；FreeRTOS专业开发、严格质量控制、稳健、有支持、不含任何知识产权所有权模糊性，并且可以在商业应用中免费使用，无需披露您的专有源代码。此外，AWS的管理提供了全球存在感、专家安全事件响应程序、庞大且多样化的开发团队、正式验证、渗透测试、内存安全证明和长期支持——同时保持FreeRTOS作为一个硬件、开发工具和云服务中立的开源项目。FreeRTOS的开发在GitHub上是透明且社区驱动的，不需要任何特殊工具或开发实践。

您可以使用FreeRTOS将产品推向市场，甚至不需要告知我们，更不用说支付任何费用，成千上万的公司就是这样做的。如果您在任何时候希望获得额外的支持，或者如果您的法律团队需要额外的书面保证或赔偿，那么我们的战略合作伙伴提供了简单、低成本的商业许可选项。知道您可以随时选择商业路径，心安理得。


### 1.1.3 术语说明

在FreeRTOS中，每个执行线程称为“任务”。嵌入式社区内部对术语没有达成共识，但我更倾向于使用“任务”而不是“线程”，因为在某些应用领域，“线程”可能有更具体的含义。

### 1.1.4 为什么使用RTOS？

有许多成熟的技术可以在不使用多线程内核的情况下编写优秀的嵌入式软件。如果正在开发的系统较为简单，那么这些技术可能提供最合适的解决方案。在更复杂的情况下，使用内核可能更可取，但交叉点在哪里总是主观的。

如前所述，任务优先级可以帮助确保应用程序满足其处理截止日期，但内核还可以带来其他不太明显的好处。以下简要列出了一些好处。

- 抽象化时间信息

  RTOS负责执行时间并为应用程序提供与时间相关的API。这使得应用程序代码的结构更加简单，整体代码量更小。

- 可维护性/可扩展性

  抽象化时间细节可以减少模块之间的相互依赖，使软件能够以受控和可预测的方式演进。此外，内核负责时间管理，因此应用程序性能对底层硬件的变化不那么敏感。

- 模块化

  任务是独立的模块，每个模块都应该有明确定义的目的。

- 团队开发

  任务还应该有明确定义的接口，从而使团队开发更加容易。

- 更容易测试

  具有清晰接口的独立模块任务更容易在隔离环境中进行测试。

- 代码重用

  设计更加模块化且相互依赖性较少的代码更容易重用。

- 提高效率

  使用RTOS的应用程序代码可以完全是事件驱动的。不需要浪费处理时间去轮询尚未发生的事件。

  与事件驱动带来的效率提升相对的是，需要处理RTOS的时钟中断并在任务之间切换执行。然而，不使用RTOS的应用程序通常也会包含某种形式的时钟中断。

- 空闲时间

  自动创建的空闲任务在没有需要处理的应用程序任务时执行。空闲任务可以测量剩余的处理能力，执行后台检查，或者将处理器置于低功耗模式。

- 功耗管理

  使用RTOS带来的效率提升使得处理器可以花更多时间处于低功耗模式。

  通过在每次空闲任务运行时将处理器置于低功耗状态，可以显著减少功耗。FreeRTOS还有一种特殊的无时钟模式。使用无时钟模式可以使处理器进入比其他情况下更低的功耗模式，并保持更长时间在低功耗模式下。

- 灵活的中断处理

  中断处理程序可以通过将处理延迟到应用程序编写者创建的任务或自动创建的RTOS守护任务（也称为定时器任务）来保持非常短。

- 混合处理需求

  简单的设计模式可以在应用程序中实现周期性、连续和事件驱动处理的混合。此外，通过选择合适的任务和中断优先级，可以满足硬实时和软实时需求。

### 1.1.5 FreeRTOS 内核功能

FreeRTOS 内核具有以下标准功能：

- 可抢占或合作操作
- 可选的时间片轮转
- 非常灵活的任务优先级分配
- 灵活、快速和轻量级的任务通知机制
- 队列
- 二进制信号量
- 计数信号量
- 互斥锁
- 递归互斥锁
- 软件定时器
- 事件组
- 流缓冲区
- 消息缓冲区
- 协程（已弃用）
- 系统节拍钩子函数
- 空闲钩子函数
- 栈溢出检查
- 跟踪宏
- 任务运行时统计信息收集
- 可选的商业许可和支持
- 完全的中断嵌套模型（适用于某些架构）
- 适用于极低功耗应用的无节拍能力（适用于某些架构）
- 内存保护单元支持，用于隔离任务并增加应用程序安全性（适用于某些架构）
- 适当时的软件管理中断栈（这可以帮助节省RAM）
- 使用静态或动态分配的内存创建RTOS对象的能力


### 1.1.6 许可证、FreeRTOS、OpenRTOS 和 SafeRTOS 系列

**FreeRTOS** 的 MIT 开源许可证旨在确保：

- FreeRTOS 可以用于商业应用程序。
- FreeRTOS 本身对所有人保持免费可用。
- FreeRTOS 用户保留其知识产权。

有关最新的开源许可信息，请访问 <https://www.FreeRTOS.org/license>。

**OpenRTOS** 是由第三方在亚马逊网络服务的许可下提供的 FreeRTOS 的商业许可版本。

**SafeRTOS** 与 FreeRTOS 共享相同的使用模型，但是根据符合各种国际公认的安全相关标准的实践、程序和流程开发的。

## 1.2 包含的源文件和项目

### 1.2.1 获取本书附带的示例

从 <https://www.FreeRTOS.org/Documentation/code> 下载的 zip 文件包含了构建和执行本书中介绍的示例所需的所有源代码、预配置的项目文件和说明。请注意，zip 文件可能不包含 FreeRTOS 的最新版本。

本书中包含的屏幕截图显示了示例在 Microsoft Windows 环境中执行，使用 FreeRTOS Windows 端口。使用 FreeRTOS Windows 端口的项目已预配置为使用从 <https://www.visualstudio.com/> 获取的免费社区版 Visual Studio 构建。请注意，虽然 FreeRTOS Windows 端口提供了一个方便的评估、测试和开发平台，但它并不提供真正的实时行为。


